<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>WarrenGami SEL Toolkit - Page 7: Assessment & Reflection (Interactive)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --midnight-blue: #002b5c;
            --sky-blue: #73bdf5;
            --ice-blue: #cfe9ff;
            --soft-gray: #e0e6ed;
            --white: #ffffff;
            --star-gold: #ffc107;
            /* --- Nav Bar Colors --- */
            --nav-bg: #f8f9fa;
            --nav-border: #dee2e6;
            --nav-text: #212529;
            --nav-primary-bg: #002b5c;
            --nav-primary-hover: #00408a;
            --nav-secondary-text: #002b5c;
            --nav-secondary-hover: #73bdf5;
            --nav-shadow: rgba(0, 0, 0, 0.1);
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Atkinson Hyperlegible', sans-serif;
            line-height: 1.4;
            color: var(--midnight-blue);
            background-color: #f0f4f8;
            font-size: 12px;
            padding-bottom: 80px; /* Space for new nav bar */
        }
        .page-container {
            width: 148mm;
            min-height: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .page-content {
            flex: 1 0 auto;
            padding: 10mm;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--sky-blue);
            padding-bottom: 3px;
            margin-top: 15px;
            margin-bottom: 12px;
        }
        h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            margin: 0 0 10px 0;
        }
        h2 { font-size: 16px; color: var(--midnight-blue); margin: 0; }
        h3 { font-size: 14px; }
        h4 { font-size: 13px; }
        p { font-size: 11px; margin: 0 0 10px 0; }

        .assessment-section {
            background-color: var(--soft-gray);
            border-radius: 5px;
            padding: 12px;
            margin: 12px 0;
        }
        
        .prompt-table {
            width: 100%; border-collapse: collapse; margin: 8px 0;
            font-size: 10px; background-color: var(--white);
            border-radius: 5px; overflow: hidden;
        }
        .prompt-table th {
            background-color: var(--midnight-blue); color: var(--white);
            padding: 8px; text-align: left;
        }
        .prompt-table td {
            padding: 8px; border-bottom: 1px solid var(--soft-gray);
            text-align: center; vertical-align: middle;
        }
        .prompt-table th[scope="row"] {
            text-align: left; background-color: var(--ice-blue);
            color: var(--midnight-blue);
        }
        .prompt-table tr:last-child td { border-bottom: none; }
        .prompt-table tr:nth-child(even) td { background-color: #f8fbff; }

        .rating-stars {
            display: flex; justify-content: center; gap: 2px;
            border-radius: 4px; padding: 2px;
        }
        .rating-stars:focus-visible {
            outline: 2px solid var(--midnight-blue);
            outline-offset: 1px;
        }
        .rating-stars .star {
            cursor: pointer; font-size: 18px; color: transparent;
            -webkit-text-stroke: 1px var(--sky-blue);
            transition: color 0.2s, -webkit-text-stroke 0.2s;
        }
        .rating-stars .star.selected {
            color: var(--star-gold); -webkit-text-stroke: 0;
        }
        .rating-stars:hover .star { color: var(--star-gold); -webkit-text-stroke: 0; }
        .rating-stars .star:hover ~ .star {
            color: transparent; -webkit-text-stroke: 1px var(--sky-blue);
        }
        #growth-score {
            font-size: 14px; font-weight: bold; color: var(--midnight-blue);
        }

        .reflection-section {
            background-color: var(--soft-gray);
            border-radius: 5px; padding: 12px; margin: 12px 0;
        }
        
        #teacher-reflection {
            width: 100%; box-sizing: border-box;
            border: 2px solid var(--sky-blue); padding: 10px; margin: 8px 0;
            background-color: var(--white);
            background-image: linear-gradient(var(--ice-blue) 1px, transparent 1px);
            background-size: 100% 1.4em; line-height: 1.4em;
            font-family: 'Atkinson Hyperlegible', sans-serif;
            font-size: 11px; color: var(--midnight-blue);
            min-height: 80px; resize: vertical; border-radius: 5px;
        }
        #teacher-reflection:focus { outline: 2px solid var(--midnight-blue); }

        #celebration-generator {
            background-color: var(--soft-gray); border-radius: 5px;
            padding: 12px; margin: 12px 0; text-align: center;
        }
        #celebration-display {
            background-color: var(--white); border-radius: 5px;
            border: 2px solid var(--sky-blue); padding: 10px; min-height: 60px;
        }
        #celebration-display h4 { margin: 0; font-size: 13px; }
        #celebration-display p { margin: 5px 0 0 0; font-size: 11px; }

        #new-celebration-btn {
            background-color: var(--midnight-blue); color: var(--white);
            font-family: 'Poppins', sans-serif; font-size: 13px; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer;
            transition: background-color 0.3s; margin-top: 10px;
        }
        #new-celebration-btn:hover { background-color: var(--sky-blue); }

        .teacher-tip {
            background-color: var(--soft-gray); border-radius: 5px;
            padding: 0; margin: 12px 0; border-left: 3px solid var(--sky-blue);
            transition: background-color 0.3s;
        }
        .teacher-tip.open { background-color: #d4dde6; }
        .teacher-tip h4 {
            margin: 0; padding: 10px; display: flex; align-items: center;
            font-size: 12px; cursor: pointer; border-radius: 5px;
            transition: background-color 0.3s;
        }
        .teacher-tip h4:hover { background-color: var(--ice-blue); }
        .teacher-tip h4:focus-visible { outline: 2px solid var(--midnight-blue); outline-offset: -1px; }
        .teacher-tip h4:before { content: "‚òÖ"; margin-right: 5px; }
        .teacher-tip .tip-content {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 10px;
        }
        .teacher-tip.open .tip-content { max-height: 100px; padding: 0 10px 10px 10px; }
        .teacher-tip h4 .toggle-icon { margin-left: auto; transition: transform 0.4s; }
        .teacher-tip.open .toggle-icon { transform: rotate(180deg); }
        
        .print-button {
            background-color: var(--soft-gray); border: 1px solid var(--ice-blue);
            color: var(--midnight-blue); padding: 5px 10px; border-radius: 15px;
            cursor: pointer; font-size: 11px; font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        .print-button:hover { background-color: var(--sky-blue); color: var(--white); }

        .footer {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            font-size: 9px; color: var(--midnight-blue);
            border-top: 1px solid var(--soft-gray); padding: 10px;
        }
        .footer-logo { height: 12px; }
        .page-number { font-family: 'Poppins', sans-serif; }
        .footer-tagline { font-style: italic; color: var(--sky-blue); }

        /* --- NEW NAVIGATION BAR STYLES --- */
        .toolkit-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--nav-bg); display: flex;
            justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; box-shadow: 0 -2px 10px var(--nav-shadow);
            border-top: 1px solid var(--nav-border); z-index: 1000; box-sizing: border-box;
        }
        .toolkit-nav a {
            font-family: 'Poppins', sans-serif; text-decoration: none;
            border-radius: 8px; transition: all 0.2s ease-in-out;
            display: inline-flex; align-items: center; justify-content: center; font-weight: 600;
        }
        .nav-button {
            background-color: var(--nav-primary-bg); color: #ffffff; padding: 0.6rem 1rem;
        }
        .nav-button:hover, .nav-button:focus-visible {
            background-color: var(--nav-primary-hover); transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--nav-shadow);
        }
        .nav-home-link {
            color: var(--nav-secondary-text); font-size: 1rem; gap: 0.5rem;
        }
        .nav-home-link:hover, .nav-home-link:focus-visible {
            color: var(--nav-secondary-hover); text-decoration: underline;
        }
        .toolkit-nav a:focus-visible { outline: 2px solid var(--nav-primary-hover); outline-offset: 2px; }

        @media print {
            body { padding-bottom: 0; }
            .print-button, .toolkit-nav, #new-celebration-btn, #celebration-generator, #generate-student-version-btn { display: none !important; }
            .teacher-tip .tip-content { max-height: none !important; overflow: visible !important; padding-top: 8px !important; }
            .teacher-tip h4 .toggle-icon, .teacher-tip h4 { cursor: default; }
            .rating-stars .star { font-size: 16px; -webkit-text-stroke: 1px var(--midnight-blue); }
            .rating-stars .star.selected { color: var(--star-gold); -webkit-text-stroke: 0; }
            #teacher-reflection { resize: none; min-height: 120px; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <main class="page-content">
            <div class="page-header">
                 <h2>Assessment & Reflection Tools</h2>
                 <button class="print-button" onclick="window.print()">üñ®Ô∏è Print Page</button>
            </div>
            <p>Monitor student growth in SEL competencies and reflect on implementation effectiveness.</p>

            <section class="assessment-section">
                 <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;">
                    <h3 style="margin: 0;">Student Self-Assessment</h3>
                    <!-- Removed the Generate Shareable Student Version button -->
                </div>
                <p style="color: #b00; font-weight: bold; margin-top: 1em;">For digital self-assessment, use the dashboard‚Äôs <em>Start Collecting SEL Data</em> button.</p>
                <!-- Add Student Name input at the top of the assessment section -->
                <div style="margin-bottom:1em;">
                    <label for="student-name" style="font-weight:bold;">Student Name:</label>
                    <input type="text" id="student-name" placeholder="Enter your name" style="margin-left:1em;">
                </div>
                <p style="margin-bottom: 4px; margin-top: 8px;">Use your Arrow Keys or click the stars to rate your skills (1 = needs work, 5 = very strong):</p>
                <table class="prompt-table">
                    <thead><tr><th scope="col">Skill</th><th scope="col">Beginning</th><th scope="col">Now</th></tr></thead>
                    <tbody>
                        <tr data-skill-label="Naming my emotions">
                            <th scope="row">Naming my emotions</th>
                            <td><div class="rating-stars" data-col="beginning" onkeydown="handleStarKeydown(event)"></div></td>
                            <td><div class="rating-stars" data-col="now" onkeydown="handleStarKeydown(event)"></div></td>
                        </tr>
                        <tr data-skill-label="Calming myself down">
                            <th scope="row">Calming myself down</th>
                            <td><div class="rating-stars" data-col="beginning" onkeydown="handleStarKeydown(event)"></div></td>
                            <td><div class="rating-stars" data-col="now" onkeydown="handleStarKeydown(event)"></div></td>
                        </tr>
                        <tr data-skill-label="Understanding others' feelings">
                            <th scope="row">Understanding others' feelings</th>
                            <td><div class="rating-stars" data-col="beginning" onkeydown="handleStarKeydown(event)"></div></td>
                            <td><div class="rating-stars" data-col="now" onkeydown="handleStarKeydown(event)"></div></td>
                        </tr>
                        <tr data-skill-label="Solving conflicts peacefully">
                            <th scope="row">Solving conflicts peacefully</th>
                            <td><div class="rating-stars" data-col="beginning" onkeydown="handleStarKeydown(event)"></div></td>
                            <td><div class="rating-stars" data-col="now" onkeydown="handleStarKeydown(event)"></div></td>
                        </tr>
                        <tr>
                            <th scope="row" style="text-align:right;">Total Growth Score:</th>
                            <td colspan="2"><span id="growth-score">+0</span></td>
                        </tr>
                    </tbody>
                </table>
                <!-- Remove the old submit button and status span -->
            </section>

            <!-- Pillar 2: Student Reflection and Goal-Setting -->
            <section class="reflection-section">
                <h3>My Reflection</h3>
                <label for="reflection-proud">The skill I am most proud of improving is...</label>
                <textarea id="reflection-proud" rows="2" style="width:100%;margin-bottom:1em;"></textarea>
                <label for="reflection-success">One time I successfully used one of these skills was when...</label>
                <textarea id="reflection-success" rows="2" style="width:100%;margin-bottom:1em;"></textarea>
                <h3>My Next Step</h3>
                <label for="goal-skill">What is one SEL skill you want to focus on practicing?</label>
                <select id="goal-skill" style="width:100%;margin-bottom:1em;">
                    <option value="">- Select a skill -</option>
                    <option>Naming my emotions</option>
                    <option>Calming myself down</option>
                    <option>Understanding others' feelings</option>
                    <option>Solving conflicts peacefully</option>
                </select>
                <label for="goal-strategy">One small way I can practice this is by...</label>
                <textarea id="goal-strategy" rows="2" style="width:100%;margin-bottom:1em;"></textarea>
                <button id="submit-assessment-btn" class="sel-data-btn" style="margin-top:1em;">Submit My Reflection</button>
                <span id="submit-status" style="margin-left:1em;color:#27ae60;"></span>
            </section>

            <section id="celebration-generator">
                <h3>Celebration Ideas</h3>
                <div id="celebration-display" aria-live="polite" aria-atomic="true">
                    <h4>Click the button to get an idea!</h4>
                    <p>A celebration activity will appear here.</p>
                </div>
                <button id="new-celebration-btn" onclick="displayRandomCelebration()">Get Celebration Idea</button>
            </section>
        </main>

        <footer class="footer">
            <span class="footer-tagline">Where Play Meets Emotional Growth</span>
            <span class="page-number">7</span>
            <img class="footer-logo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='60' height='20' viewBox='0 0 60 20'><text x='0' y='15' font-family='Poppins' font-size='12' fill='%23002b5c'>WarrenGami</text></svg>"/>
        </footer>
    </div>
     <nav class="toolkit-nav" aria-label="Toolkit Paging">
        <a href="Page 6 - Family Connection Activities.html" class="nav-button" aria-label="Go to Previous Page">‚¨ÖÔ∏è Previous</a>
        <a href="dashboard.html" class="nav-home-link" aria-label="Go to Table of Contents">
            <span aria-hidden="true">üè†</span>
            <span>Teacher Dashboard</span>
        </a>
        <a href="Page 8 - Advanced SEL Concepts.html" class="nav-button" aria-label="Go to Next Page">Next ‚û°Ô∏è</a>
     </nav>
     <script>
            function setRating(container, value) {
                const newValue = Math.max(0, Math.min(5, value)); // Clamp value between 0 and 5
                container.setAttribute('aria-valuenow', newValue);
                const stars = container.querySelectorAll('.star');
                stars.forEach(star => {
                    star.classList.toggle('selected', parseInt(star.dataset.value) <= newValue);
                });
                calculateGrowth();
            }

            function handleStarKeydown(event) {
                const container = event.currentTarget;
                let currentValue = parseInt(container.getAttribute('aria-valuenow'));
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    setRating(container, currentValue + 1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    setRating(container, currentValue - 1);
                }
            }

            function calculateGrowth() {
                let totalBeginning = 0;
                let totalNow = 0;
                const rows = document.querySelectorAll('tbody tr[data-skill-label]');
                rows.forEach(row => {
                    const beginningRating = parseInt(row.querySelector('[data-col="beginning"]').getAttribute('aria-valuenow')) || 0;
                    const nowRating = parseInt(row.querySelector('[data-col="now"]').getAttribute('aria-valuenow')) || 0;
                    totalBeginning += beginningRating;
                    totalNow += nowRating;
                });
                const growth = totalNow - totalBeginning;
                const growthEl = document.getElementById('growth-score');
                if (growthEl) { // Check if the element exists
                    growthEl.innerText = (growth >= 0 ? '+' : '') + growth;
                }
            }

            function toggleTip(headerElement) {
                const tip = headerElement.closest('.teacher-tip');
                const isOpening = tip.classList.toggle('open');
                headerElement.setAttribute('aria-expanded', isOpening);
            }

             function handleTipKeydown(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    toggleTip(event.currentTarget);
                }
             }

            const celebrations = [
                { title: "Growth Showcase", description: "Students share one specific SEL skill they've noticed they improved." },
                { title: "Kindness Chain", description: "Create a paper chain, adding a new link for each act of kindness observed in the classroom." },
                { title: "Appreciation Circle", description: "Sit in a circle and have each student give a specific, genuine compliment to the person next to them." },
                { title: "Problem-Solving Stars", description: "Award paper stars to students or groups who solve a conflict peacefully and respectfully." },
                { title: "SEL Story Time", description: "Share a success story about how the class used an SEL skill to overcome a challenge together." }
            ];
            const celebrationTitleEl = document.querySelector('#celebration-display h4');
            const celebrationDescEl = document.querySelector('#celebration-display p');

            function displayRandomCelebration() {
                const randomIndex = Math.floor(Math.random() * celebrations.length);
                const celebration = celebrations[randomIndex];
                celebrationTitleEl.innerText = celebration.title;
                celebrationDescEl.innerText = celebration.description;
            }

            function generateStudentPage() {
                // BUG FIX: Generate the table HTML from scratch to avoid duplicating stars.
                let studentTableRowsHTML = '';
                document.querySelectorAll('.prompt-table tbody tr[data-skill-label]').forEach(row => {
                    const skillLabel = row.dataset.skillLabel;
                    // Use textContent to get the clean label text without any other elements.
                    const skillText = row.querySelector('th[scope="row"]').textContent;
                    studentTableRowsHTML += `
                        <tr data-skill-label="${skillLabel}">
                            <th scope="row">${skillText}</th>
                            <td><div class="rating-stars" data-col="beginning" onkeydown="handleStarKeydown(event)"></div></td>
                            <td><div class="rating-stars" data-col="now" onkeydown="handleStarKeydown(event)"></div></td>
                        </tr>`;
                });

                // Add the specific "Total Growth Score" row for the student view, matching the image.
                studentTableRowsHTML += `
                    <tr>
                        <th scope="row">Total Growth Score:</th>
                        <td colspan="2" style="text-align:center;"><span id="growth-score">-</span></td>
                    </tr>`;

                const studentTableHTML = `
                <table class="prompt-table">
                    <thead><tr><th scope="col">Skill</th><th scope="col">Beginning</th><th scope="col">Now</th></tr></thead>
                    <tbody>
                        ${studentTableRowsHTML}
                    </tbody>
                </table>`;
                
                // Now, create the full student page with the clean, generated table.
                const studentHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student SEL Self-Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --midnight-blue: #002b5c; --sky-blue: #73bdf5; --ice-blue: #cfe9ff;
            --soft-gray: #e0e6ed; --white: #ffffff; --star-gold: #ffc107;
        }
        body {
            font-family: 'Atkinson Hyperlegible', sans-serif; line-height: 1.4; color: var(--midnight-blue);
            background-color: #f0f4f8; font-size: 14px; padding: 20px;
        }
        .container { max-width: 700px; margin: 0 auto; background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1, h2 { font-family: 'Poppins', sans-serif; }
        h1 { font-size: 22px; } h2 { font-size: 18px; }
        .assessment-section, .summary-section { background-color: var(--soft-gray); border-radius: 5px; padding: 15px; margin: 15px 0; }
        .prompt-table { width: 100%; border-collapse: collapse; font-size: 13px; background-color: var(--white); border-radius: 5px; overflow: hidden; }
        .prompt-table th { background-color: var(--midnight-blue); color: var(--white); padding: 10px; text-align: left; }
        .prompt-table td { padding: 10px; border-bottom: 1px solid var(--soft-gray); text-align: center; vertical-align: middle; }
        .prompt-table th[scope="row"] { text-align: left; background-color: var(--ice-blue); color: var(--midnight-blue); font-weight: bold; }
        .prompt-table tr:last-child td, .prompt-table tr:last-child th { border-bottom: none; background-color: var(--ice-blue) !important; }
        .prompt-table tr:nth-child(even) td { background-color: #f8fbff; }
        .rating-stars { display: flex; justify-content: center; gap: 3px; }
        .rating-stars:focus-visible { outline: 2px solid var(--midnight-blue); outline-offset: 1px; }
        .rating-stars .star { cursor: pointer; font-size: 24px; color: transparent; -webkit-text-stroke: 1px var(--sky-blue); transition: all 0.2s; }
        .rating-stars .star.selected { color: var(--star-gold); -webkit-text-stroke: 0; }
        .rating-stars:hover .star { color: var(--star-gold); -webkit-text-stroke: 0; }
        .rating-stars .star:hover ~ .star { color: transparent; -webkit-text-stroke: 1px var(--sky-blue); }
        #growth-score { font-size: 16px; font-weight: bold; color: var(--midnight-blue); }
        #student-name { width: 100%; padding: 8px; font-size: 14px; border: 2px solid var(--sky-blue); border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; }
        .button { background-color: var(--midnight-blue); color: var(--white); font-family: 'Poppins', sans-serif; font-size: 15px; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-top: 10px; }
        .button:hover { background-color: var(--sky-blue); }
        #summary-output { width: 100%; min-height: 200px; margin-top: 10px; font-family: monospace; font-size: 12px; white-space: pre; background: #fdfdfd; border: 1px solid var(--sky-blue); border-radius: 4px; padding: 10px; }
        #copy-instructions { font-size: 12px; font-style: italic; color: #555; display: none; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>My SEL Skills Self-Assessment</h1>
        <p>Hello! Please enter your name and then rate your skills below. The "Beginning" column is for how you felt at the start of the term, and "Now" is for how you feel today. When you're done, click the 'Create Summary' button at the bottom.</p>
        
        <input type="text" id="student-name" placeholder="Enter your full name here">

        <section class="assessment-section">
            <h2>My Skills Rating</h2>
            <p style="font-size:12px;">Use your Arrow Keys or click the stars to rate your skills (1 = needs work, 5 = very strong):</p>
            ${studentTableHTML}
        </section>

        <section class="summary-section">
            <h2>Create Your Summary</h2>
            <p>After rating all your skills, click this button to create a summary.</p>
            <button class="button" onclick="generateSummary()">Create Summary for Teacher</button>
            <p id="copy-instructions">Great! Now, please copy all the text from the box below and send it to your teacher in an email.</p>
            <textarea id="summary-output" readonly placeholder="Your summary will appear here..."></textarea>
        </section>
    </div>

    <script>
        function setRating(container, value) {
            const newValue = Math.max(0, Math.min(5, value));
            container.setAttribute('aria-valuenow', newValue);
            const stars = container.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.toggle('selected', parseInt(star.dataset.value) <= newValue);
            });
            calculateGrowth();
        }
        function handleStarKeydown(event) {
            const container = event.currentTarget;
            let currentValue = parseInt(container.getAttribute('aria-valuenow'));
            if (event.key === 'ArrowRight') { event.preventDefault(); setRating(container, currentValue + 1); }
            else if (event.key === 'ArrowLeft') { event.preventDefault(); setRating(container, currentValue - 1); }
        }
        function calculateGrowth() {
            let totalBeginning = 0, totalNow = 0;
            document.querySelectorAll('tbody tr[data-skill-label]').forEach(row => {
                totalBeginning += parseInt(row.querySelector('[data-col="beginning"]').getAttribute('aria-valuenow')) || 0;
                totalNow += parseInt(row.querySelector('[data-col="now"]').getAttribute('aria-valuenow')) || 0;
            });
            const growth = totalNow - totalBeginning;
            const growthEl = document.getElementById('growth-score');
            if (growthEl) {
                growthEl.innerText = (growth >= 0 ? '+' : '') + growth;
            }
        }
        window.onload = () => {
            document.querySelectorAll('.rating-stars').forEach(container => {
                const tr = container.closest('tr');
                if (!tr) return;
                const skillLabel = tr.dataset.skillLabel;
                const timeLabel = container.dataset.col;
                container.setAttribute('role', 'slider'); container.setAttribute('tabindex', '0');
                container.setAttribute('aria-valuemin', '0'); container.setAttribute('aria-valuemax', '5');
                container.setAttribute('aria-label', \`Rating for \${skillLabel} (\${timeLabel})\`);
                container.setAttribute('aria-valuenow', 0);
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star'; star.innerText = '‚òÖ'; star.dataset.value = i;
                    star.onclick = (event) => {
                        event.stopPropagation();
                        const currentValue = parseInt(container.getAttribute('aria-valuenow'));
                        const clickedValue = parseInt(star.dataset.value);
                        setRating(container, currentValue === clickedValue ? 0 : clickedValue);
                    };
                    container.appendChild(star);
                }
            });
            calculateGrowth();
        };

        function generateSummary() {
            const studentName = document.getElementById('student-name').value;
            if (!studentName) {
                alert('Please enter your name before creating the summary.');
                document.getElementById('student-name').focus();
                return;
            }
            let summary = \`SEL Self-Assessment Summary\\n\`;
            summary += \`Student: \${studentName}\\n\`;
            summary += \`Date: \${new Date().toLocaleDateString()}\\n\`;
            summary += \`=====================================\\n\`;
            document.querySelectorAll('tbody tr[data-skill-label]').forEach(row => {
                const skill = row.dataset.skillLabel;
                const beginning = row.querySelector('[data-col="beginning"]').getAttribute('aria-valuenow') || '0';
                const now = row.querySelector('[data-col="now"]').getAttribute('aria-valuenow') || '0';
                summary += \`\\n\${skill}:\\n\`;
                summary += \`  - Beginning Rating: \${beginning} / 5\\n\`;
                summary += \`  - Current Rating:   \${now} / 5\\n\`;
            });
            summary += \`\\n=====================================\\n\`;
            const growth = document.getElementById('growth-score').innerText;
            summary += \`Total Growth Score: \${growth}\\n\`;
            
            const output = document.getElementById('summary-output');
            output.value = summary;
            output.focus();
            output.select();
            document.getElementById('copy-instructions').style.display = 'block';
        }
    <\/script>
</body>
</html>
                `;

                const blob = new Blob([studentHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'student-self-assessment.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            window.onload = () => {
                const ratingContainers = document.querySelectorAll('.rating-stars');
                ratingContainers.forEach(container => {
                    // Make sure this only runs if the container is empty, to avoid any potential duplication.
                    if (container.children.length > 0) return;

                    const skillLabel = container.closest('tr').dataset.skillLabel;
                    const timeLabel = container.dataset.col;
                    container.setAttribute('role', 'slider');
                    container.setAttribute('tabindex', '0');
                    container.setAttribute('aria-valuemin', '0');
                    container.setAttribute('aria-valuemax', '5');
                    container.setAttribute('aria-label', `Rating for ${skillLabel} (${timeLabel})`);
                    container.setAttribute('aria-valuenow', 0);
                    
                    for (let i = 1; i <= 5; i++) {
                        const star = document.createElement('span');
                        star.className = 'star';
                        star.innerText = '‚òÖ';
                        star.dataset.value = i;
                        star.onclick = (event) => {
                            event.stopPropagation();
                            const currentValue = parseInt(container.getAttribute('aria-valuenow'));
                            const clickedValue = parseInt(star.dataset.value);
                            setRating(container, currentValue === clickedValue ? 0 : clickedValue);
                        };
                        container.appendChild(star);
                    }
                });
                displayRandomCelebration();
                calculateGrowth();

                document.getElementById('generate-student-version-btn').addEventListener('click', generateStudentPage);
            };

    // Pillar 2: Submission logic
    function getRating(skill, col) {
        const row = document.querySelector(`tr[data-skill-label="${skill}"]`);
        if (!row) return '';
        const container = row.querySelector(`[data-col="${col}"]`);
        return container ? (container.getAttribute('aria-valuenow') || '') : '';
    }

    function submitStudentAssessment() {
        const status = document.getElementById('submit-status');
        const btn = document.getElementById('submit-assessment-btn');
        status.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        // Get Google Form link
        const gformLink = localStorage.getItem('selToolkit-gformLink');
        if (!gformLink) {
            status.textContent = 'Error: Data Hub is not set up. Please ask your teacher.';
            status.style.color = '#e74c3c';
            btn.disabled = false;
            btn.textContent = 'Submit My Reflection';
            return;
        }

        // Gather data
        const name = document.getElementById('student-name').value.trim();
        if (!name) {
            status.textContent = 'Please enter your name.';
            status.style.color = '#e74c3c';
            btn.disabled = false;
            btn.textContent = 'Submit My Reflection';
            document.getElementById('student-name').focus();
            return;
        }
        const date = new Date().toISOString().slice(0,10);
        const skills = [
            "Naming my emotions",
            "Calming myself down",
            "Understanding others' feelings",
            "Solving conflicts peacefully"
        ];
        let params = new URLSearchParams();
        params.append('entry.NAME', name); // Replace with real entry IDs below
        params.append('entry.DATE', date);
        // Ratings
        skills.forEach(skill => {
            params.append(`entry.${skill.replace(/\s/g,'_').replace(/'/g,'')}_beginning`, getRating(skill, 'beginning'));
            params.append(`entry.${skill.replace(/\s/g,'_').replace(/'/g,'')}_now`, getRating(skill, 'now'));
        });
        params.append('entry.TOTAL_GROWTH', document.getElementById('growth-score').innerText);
        // Reflection
        params.append('entry.PROUD', document.getElementById('reflection-proud').value.trim());
        params.append('entry.SUCCESS', document.getElementById('reflection-success').value.trim());
        // Goal
        params.append('entry.GOAL_SKILL', document.getElementById('goal-skill').value);
        params.append('entry.GOAL_STRATEGY', document.getElementById('goal-strategy').value.trim());

        // TODO: Replace entry.NAME, entry.DATE, etc. with actual Google Form entry IDs
        // Example: params.append('entry.123456789', name);

        // Build final URL
        let url = gformLink.split('/viewform')[0] + '/formResponse?' + params.toString();
        fetch(url, { method: 'POST', mode: 'no-cors' })
            .then(() => {
                status.textContent = '‚úÖ Submitted!';
                status.style.color = '#27ae60';
                btn.textContent = 'Submitted!';
                setTimeout(()=>{
                    status.textContent = '';
                    btn.textContent = 'Submit My Reflection';
                    btn.disabled = false;
                }, 3000);
                // Optionally clear form fields
            })
            .catch(() => {
                status.textContent = 'Submission failed. Please try again.';
                status.style.color = '#e74c3c';
                btn.disabled = false;
                btn.textContent = 'Submit My Reflection';
            });
    }
    document.getElementById('submit-assessment-btn').onclick = submitStudentAssessment;
    </script>
        <!-- Remove the old Google Form JS logic for submit-assessment -->
        <script src="auth.js"></script>
        <!-- TIDIO CHATBOT SCRIPT -->
        <script src="//code.tidio.co/al0nn6gytvaa7zsgua0omcgzljz8yl0e.js" async></script>

    </body>
    </html>
